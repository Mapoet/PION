\documentclass[a4paper,11pt]{article}
%\documentclass[a4paper,11pt,draft]{article}


\usepackage{graphicx}
\usepackage{natbib}
\bibliographystyle{../../../documentation_misc/bibtex/apj.bst}
\usepackage{amsmath}
\usepackage{amssymb}

\usepackage{color}
% Definition for highlighting changes in red
%\def\changed{}
\def\changed{\color{red}}

\input{../../../documentation_misc/bibtex/defs}

\usepackage[T1]{fontenc}
\usepackage{times}
%
% BORDERS:
% HORIZONTAL:	210mm - 50.8mm = 159.2mm ROUNDED TO 16cm
% VERTICAL:	297mm - 50.8mm = 246.2mm ROUNDED TO 25cm
%
\setlength{\oddsidemargin}{0.0cm}
\setlength{\textwidth}{16.0cm}
\setlength{\topmargin}{-1.5cm}
\setlength{\textheight}{25.0cm}
\parindent = 0.0 truept
\parskip = 6.0 truept

\title{Multifrequency photoionisation for H and He}
\author{Jonathan Mackey (AIfA)}
\date{August 2012}

\begin{document}
\maketitle

\section{Introduction and theoretical background}
A method is presented in \citet{FraMel94} for calculating the photoionisation rates of H and He based on previous work by \citet{TenBodNor86} (the citation in \citealt{FraMel94}  is for a 1983 proceedings, but this one in 1986 is the only one I can find; maybe it took 3 years to get published).
The method is later presented in summary form in \citet{RodTen98} together with a figure showing the degree of accuracy of the approximations used.
It allows one to pre-calculate the photoionisation and photoheating rates for a given radiation source spectrum as a function of column density of H$^0$, He$^0$, and HE$^+$ in one-dimensional tables instead of a three-dimensional table, which has huge advantages in terms of speed.

The photoionisation rate per second per neutral atom is 
\begin{equation}
A_{\mr{pi}} = \int_{\nu_{\mr{th}}}^{\infty}
    \frac{L_\nu\sigma_\nu \mr{e}^{-\tau_\nu(r)}}{4\pi r^2 h\nu} d\nu \;,
\label{eqn:pion_rate}
\end{equation}
where $\nu$ is the photon frequency,
$\nu_{\mr{th}}$ is the frequency of the ionisation threshold for the atom, 
$L_\nu$ is the luminosity of the source in erg\,s$^{-1}$\,Hz$^{-1}$,
$\sigma_\nu$ is the frequency-dependent photoionisation cross section of the atom,
$r$ is the distance from the source, $h$ is Planck's constant, and
$\tau_\nu(r)$ is the (frequency-dependent) optical depth from the source to a distance $r$.
The optical depth is, unfortunately, a function of all of the intervening species, which we can safely assume is just H and He in the EUV because of their abundances.
It is then given by
\begin{equation}
\frac{d\tau_\nu}{dr} = n(\mr{H}^0)\sigma_\nu(\mr{H}^0)
                      +n(\mr{He}^0)\sigma_\nu(\mr{He}^0)
                      +n(\mr{He}^+)\sigma_\nu(\mr{He}^+) \;,
\end{equation}
where the species in brackets denotes which species the number density and cross-section are for.
The number-densities become column densities when this is integrated along a ray.
This is in the exponential, so the integral cannot be separated in terms of column densities.
The method introduced by Tenorio-Tagle involves splitting the integral in terms of frequency instead, and as long as the cross-sections have the same frequency dependence (which they don't!) then you can pre-calculate the frequency integrals for the combined column densities of all three species.

The photon-conserving finite-difference approximation of the photoionisation rate from \citet{MelIliAlvEA06} is
\begin{equation}
A_{\mr{pi}} = \int_{\nu_{\mr{th}}}^{\infty}
    \frac{L_\nu \mr{e}^{-\tau_\nu}}{h\nu} 
    \frac{1-\mr{e}^{-\Delta\tau_\nu}}{n_{\textsc{hi}}V_{\mr{shell}}}  d\nu \;,
\label{eqn:pion_FVrate}
\end{equation}
where $\tau_\nu$ is the optical depth to the edge of a grid-zone closest to the source, $\Delta\tau_\nu$ is the optical depth along the ray across the grid zone,
$n_{\textsc{hi}}$ is the  H$^0$ number density in the zone, and
$V_{\mr{shell}} = 4\pi[(r+\Delta r)^3-r^3]/3$ is the volume of the spherical shell with radii corresponding to the front and back intersections of the zone and ray.
As $\Delta\tau_\nu\rightarrow0$ this reduces to equation~\ref{eqn:pion_rate}.
This equation is separable into the sum of two integrals of the form
\begin{equation}
A_{\mr{pi}} = K\int_{\nu_{\mr{th}}}^{\infty}
    \frac{L_\nu \mr{e}^{-\tau_\nu}}{h\nu}  d\nu \;,
\label{eqn:pion_tab}
\end{equation}
where $K$ is a constant, so this integral is the one we will tabulate as a function of $\tau$ for a given source spectrum and luminosity.

The ionisation cross-sections can be approximately expressed as power-law functions of frequency above $\nu_{\mr{th}}$, so we write the optical depths for H, He$^0$, and He$^+$, respectively, as
\begin{align}
\tau_\nu(\mr{H}^0)  &= N_0\sigma_0\left(\frac{\nu}{\nu_0}\right)^{-s_0} = \tau_0\left(\frac{\nu}{\nu_0}\right)^{-s_0}\nonumber\\
\tau_\nu(\mr{He}^0) &= N_1\sigma_1\left(\frac{\nu}{\nu_1}\right)^{-s_1} = \tau_1\left(\frac{\nu}{\nu_1}\right)^{-s_1}\nonumber\\
\tau_\nu(\mr{He}^+) &= N_2\sigma_2\left(\frac{\nu}{\nu_2}\right)^{-s_2} = \tau_2\left(\frac{\nu}{\nu_2}\right)^{-s_2}\;.
\end{align}
Here subscript zero refers to the column density, threshold cross-section, threshold frequency, and power-law index for H$^0$ photoionisation, subsript one to He$^0$, and subscript two to He$^+$.
H$^0$ and He$^+$ have the same atomic structure so $s_0=s_2$, and $\sigma_2\approx0.25\sigma_0$ (because of charge, \citealt{Ost89}, eq.~2.2).
He$^0$ has, however, a shallower power-law slope so an approximation must be made if we want to avoid large multi-dimensional look-up tables.

The approximation made is to split the frequency integration into three regions: region A where $\nu_0\leq\nu<\nu_1$, region B where $\nu_1\leq\nu<\nu_2$, and region C where $\nu_2\leq\nu<\infty$.
In these regions it is assumed that cross sections for all species have the frequency dependence of the dominant component of the cross-section.
This is somewhat questionable, but is probably ok, see figure in \citet{RodTen98}.
It is at least a big improvement on the current scheme in \pion{} which ignores He altogether.
And it is a step on the way to a scheme where the frequency is binned similarly to \citet{FriMelIliEA12} and \citet{CanPor11}.

We define $x\equiv\nu/\nu_0$ to make the equations more compact, so $\nu_1$ corresponds to $x=24.4/13.6=1.81$, and $\nu_2$ corresponds to $x=4.00$.
The equations have been optimised by \citet{TenBodNor86} or \citet{FraMel94} to minimize the errors, and are given by \citet{FraMel94} as
\begin{align}
\tau_\textsc{a}(x) &= \tau_0 x^{-2.8}  \qquad &1\leq x<1.81 \nonumber \\
\tau_\textsc{b}(x) &= \left(0.63^{1.7}\tau_0+1.81^{1.7}\tau_1\right) x^{-1.7} \qquad &1.81\leq x<4.00 \nonumber \\
\tau_\textsc{c}(x) &= \left(\tau_0+2.73^{2.8}\tau_1+4.00^{2.8}\tau_2\right) x^{-2.8}  \qquad &x \geq 4.00
\end{align}
Now the prefactors of the power law are just numbers, so it does not matter what fraction of the column density is from which species.
We can then tabulate integrals of each of these expressions with the prefactor as the independent variable, and then when running the code we construct these combinations of column densities and feed this into the lookup table to get the rates.

The photoionisation rate integral (Eq.~\ref{eqn:pion_tab}, without the normalisation factor $K$) as a function of $x$ is then
\begin{equation}
I(\tau) = \frac{1}{h}\int_{x=1}^{\infty}
    \frac{L_\nu \mr{e}^{-\tau(x)}}{x} dx \;,
\label{eqn:pion_tab_x}
\end{equation}
and the corresponding photoheating rate integral is just the same but with the heating per ionisation in the numerator:
\begin{equation}
H(\tau) = \nu_0\int_{x=1}^{\infty}
    \frac{L_\nu \mr{e}^{-\tau(x)}(x-1)}{x} dx \;,
\label{eqn:pheat_tab_x}
\end{equation}

\section{Implementation in \pion{}}


\subsection{Cross-sections}
The normalisation of the cross sections is as follows:
\begin{itemize}
\item $\sigma_0(\mr{H}^0)  = 6.304\times10^{-18}$\,cm \citep{Ost89}.
\item $\sigma_0(\mr{He}^0) = 7.56\times10^{-18}$\,cm, from \citet{MarWes76} \citep[via][]{VerFerKorEA96}.
\item $\sigma_0(\mr{He}^+) = 1.576\times10^{-18}$\,cm \citep{Ost89}.
\end{itemize}
These values should be accurate enough for what I need.

\subsection{Photon energy spectrum}
As an upper energy limit for photon energies $x=7.35$ seems reasonable, because 100\,eV is entering the soft x-ray band.
So we really only need less than one order of magnitude in frequency.


\subsection{Blackbody spectra}
The intensity of Blackbody radiation is \citep[e.g.][]{RybLig79}
\begin{equation}
B(x,T) = \frac{2h\nu_0^3x^3}{c^2\left[\exp\left(\frac{h\nu_0x}{kT}\right)-1\right]}
\end{equation}
The luminosity of a blackbody with radius $R$ and temperature $T$ is then
\begin{equation}
L(x,R,T) = 4\pi^2R^2B(x,T) =
\frac{8\pi^2R^2h\nu_0^3x^3}{c^2\left[\exp\left(\frac{h\nu_0x}{kT}\right)-1\right]}
\end{equation}
because the emergent flux is $\pi B(x,T)$.


\subsection{Limits of the interpolation table}
The photoionisation table is interpolated in $\log_{10}\tau$ and $\log_{10}I(\tau)$, and has lower and upper limits $\tau_\mr{min}$ and $\tau_\mr{max}$ respectively.
The issue is not, however, whether we get the right answer for $I(\tau)$, but rather whether we get the right answer for
\begin{equation}
A_{\mr{pi}}(\tau_0,\Delta\tau_0) = 
    \frac{1}{n_{\textsc{hi}}V_{\mr{shell}}}
    \left[I(\tau_0) - I(\tau_0+\Delta\tau_0)\right]  \;.
\label{eqn:pionFD}
\end{equation}

There are three limits that we need to consider:
\begin{itemize}
\item
  For $\tau_0\sim1$ then in principle we can get a sensible value for $A_{\mr{pi}}$ for any value of $\Delta\tau_0$ as long as $\Delta\tau_0/\tau_0>\epsilon$, where $\epsilon$ is some measure of the numerical accuracy of the computer.
  This is good enough for most cases, and in tests it worked down to $\epsilon\sim10^{-12}$.
  In principle, however, we can do better with an analytic approximation for the case where $\Delta\tau_0\ll1$, in which case the ionisation rate approaches the local rate given by Eq.~\ref{eqn:pion_rate}.
%
\item
  For $\tau_0\ll1$ we have no problem as long as $\Delta\tau_0>\tau_\mr{min}$, otherwise the two integrals in Eq.~\ref{eqn:pionFD} will be identical.
  This is the most serious issue we face in setting the limiting optical depths.
  It doesn't make sense to use the same interpolation table down to a tiny value of $\Delta\tau_0$ when we can make a better analytic approximation.
  We can use the same approximation for all cases where $\Delta\tau_0<\tau_\mr{min}$ (i.e.\ this case, and the one above), and it is described below.
%
\item
  For $\tau\gg1$ the scaling is $\log(A_{\mr{pi}})\sim K - \tau_0$ where $K$ is a constant (and ignoring the frequency integral), or in other words the rate is exponentially damped (obviously).
  So at $\tau\gg1$ we can stop the pre-calculated table a certain number of e-foldings after the turnover, at a point where the ionisation rate is many orders of magnitude below the peak value and we no longer care what the value is.
  A physically-motivated limit is set by the Galactic cosmic ray ionisation rate of $A_{\mr{pi}}^{\textsc{cr}}(\mr{H}^0)\sim 5.0\times10^{-28}n_{\textsc{hi}} \,\pcmcps$ \citep[e.g.][]{HenArtDeCEA09}.
  Another limit is that the rate should be such that it takes longer than the age of the universe to ionise the zone.
  In any event, for whatever limit we choose we should set $A_{\mr{pi}}=0$ for $\tau_0>\tau_\mr{max}$.
%
\item
  The limit where $\tau_0\sim1$ and $\Delta\tau_0\gg1$ is numerically not difficult.
  Here the rate becomes independent of $\Delta\tau_0$ because all photons get absorbed in the cell.
  As long as the rate is not too small (i.e.~as long as $\tau_0$ is not too large) this is not a problem.
%
\end{itemize}
The limits used in testing are $\tau_\mr{min}=10^{-4}$ and $\tau_\mr{max}=10^4$, and we apply the low-$\tau$ limit if $\Delta\tau_0 <2\tau_\mr{min}$.
If $\tau>\tau_\mr{max}$, then we set the value of the integral to $10^{-200}$.


\subsection{Second interpolation for $\Delta\tau_0<2\tau_\mr{min}$}
Here the finite-difference Eq.~\ref{eqn:pionFD} reduces to 
\begin{equation}
A_{\mr{pi}}(\tau_0,\Delta\tau_0) = 
    \frac{\Delta\tau_0}{n_{\textsc{hi}}V_{\mr{shell}}} 
    \frac{1}{h} \sum_{\mr{regions}}\int_{x=x_\mr{lo}}^{x_\mr{hi}}
    L_\nu \mr{e}^{-\tau(x)} x^{-1-a} dx
  \equiv \frac{\Delta\tau_0}{n_{\textsc{hi}}V_{\mr{shell}}} I_\mr{lt}(\tau_0) \;,
\label{eqn:pion_lowtau}
\end{equation}
where $a$ is the power-law frequency-dependence of the optical depth in the spectral region $x_\mr{lo}\leq x<x_\mr{hi}$, and where the second equality defines the integral $I_\mr{lt}(\tau_0)$.
We similarly define a heating integral for $\Delta\tau_0<\tau_\mr{min}$ according to
\begin{equation}
H_\mr{lt}(\tau) = \nu_0 \sum_{\mr{regions}}\int_{x=x_\mr{lo}}^{x_\mr{hi}}
    L_\nu \mr{e}^{-\tau(x)}(x-1)x^{-1-a} dx \;.
\label{eqn:pheat_lowtau}
\end{equation}




\subsection{Random thoughts}
I'm not sure whether it is faster to have the three optical depths as three different raytracings or as one raytracing with three variables.
In pure efficiency terms it is the latter for sure, but with parallel code it's not obvious.
I should investigate both.

I would like to make the module thread-safe, so there should be no local parameters; everything should be passed around as pointers to arrays, if possible.


\section{Testing}
\subsection{Photon conservation}
The most basic test is to ensure that, in the absence of recombinations, the number of photons emitted should equal the number of electrons in the simulation.
This can be easily tested with a uniform medium on a 1D spherical grid, with hydrodynamics switched off.
The following equality should hold at all times:
\begin{equation}
\dot{N} t = \int_{r=0}^{r_\mr{max}} \left[n(\mr{H}^+)+n(\mr{He}^+)+2n(\mr{He}^{2+})\right] 4\mr{\pi}r^2dr \;,
\end{equation}
for a simulation domain $r\in[0,r_\mr{max}]$.
This can further be tested species by species by setting all helium/hydrogen to be ionised so the species cannot absorb any photons.





%{\footnotesize
\bibliography{../../../documentation_misc/bibtex/refs}
%}

\end{document}


